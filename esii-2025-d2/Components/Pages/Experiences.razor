@page "/Experiences"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Security.Claims
@using System.Diagnostics
@using esii_2025_d2.Services
@using esii_2025_d2.Models
@attribute [Authorize(Roles = "Talent")]
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject ITalentService TalentService
@inject IExperienceService ExperienceService
@rendermode InteractiveServer

<h3>Experiences</h3>

<button class="btn btn-primary mb-3" @onclick="ShowAddModal">Add New Experience</button>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Title</th>
            <th>Company</th>
            <th>Start Year</th>
            <th>End Year</th>
            <th>Talent</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (experiences == null && !initialLoadAttempted)
        {
            <tr><td colspan="6">Loading experiences...</td></tr>
        }
        else if (experiences == null || !experiences.Any())
        {
            <tr><td colspan="6">No experiences found. @(string.IsNullOrWhiteSpace(apiError) ? "" : $"Error: {apiError}")</td></tr>
        }
        else
        {
            @foreach (var exp in experiences)
            {
                <tr>
                    <td>@exp.Title</td>
                    <td>@exp.CompanyName</td>
                    <td>@exp.StartYear</td>
                    <td>@(exp.EndYear?.ToString() ?? "-")</td>
                    <td>@exp.Talent?.Name</td>
                    <td>
                        <button class="btn btn-sm btn-warning" @onclick="() => ShowEditModal(exp)">Edit</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteExperience(exp.Id)">Delete</button>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@if (showModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@((editingExperience.Id == 0) ? "Add Experience" : "Edit Experience")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="editingExperience" OnValidSubmit="SaveExperience">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="mb-3">
                            <label>Title</label>
                            <InputText class="form-control" @bind-Value="editingExperience.Title" />
                        </div>
                        <div class="mb-3">
                            <label>Company Name</label>
                            <InputText class="form-control" @bind-Value="editingExperience.CompanyName" />
                        </div>
                        <div class="mb-3">
                            <label>Start Year</label>
                            <InputNumber class="form-control" @bind-Value="editingExperience.StartYear" />
                        </div>
                        <div class="mb-3">
                            <label>End Year (optional)</label>
                            <InputNumber class="form-control" @bind-Value="editingExperience.EndYear" />
                        </div>
                        <div class="mb-3">
                            <label>Talent Profile</label>
                            @if (talents == null && !initialLoadAttempted) {
                                <p>Loading talent profiles...</p>
                            } else if (talents == null || !talents.Any()) {
                                <p>No talent profiles available. @(string.IsNullOrWhiteSpace(apiError) ? "You may need to create one first." : $"Error: {apiError}")</p>
                                <InputSelect class="form-control" @bind-Value="editingExperience.TalentId" disabled>
                                     <option value="">-- No talents available --</option>
                                </InputSelect>
                            } else {
                                <InputSelect class="form-control" @bind-Value="editingExperience.TalentId">
                                    <option value="0">-- Select Talent Profile --</option>
                                    @foreach (var t in talents)
                                    {
                                        <option value="@t.Id">@t.Name</option>
                                    }
                                </InputSelect>
                            }
                        </div>

                        <button type="submit" class="btn btn-primary" disabled="@(talents == null || !talents.Any())">Save</button>
                        <button type="button" class="btn btn-secondary ms-2" @onclick="CloseModal">Cancel</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Talent>? talents;
    private List<Experience>? experiences;
    private Experience editingExperience = new();
    private bool showModal = false;
    private string? LoggedInUserId;
    private string? apiError;
    private bool initialLoadAttempted = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        LoggedInUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        initialLoadAttempted = false; // Reset before load attempts
        apiError = null;

        if (string.IsNullOrEmpty(LoggedInUserId))
        {
            apiError = "User not authenticated.";
            Console.WriteLine(apiError);
            talents = new List<Talent>();
            experiences = new List<Experience>();
            initialLoadAttempted = true;
            return;
        }

        await LoadUserTalents();
        await LoadExperiences();
        initialLoadAttempted = true;
    }

    private async Task LoadUserTalents()
    {
        try
        {
            if (!string.IsNullOrEmpty(LoggedInUserId))
            {
                talents = await TalentService.GetMyTalentsAsync(LoggedInUserId);
            }
            if (talents == null) talents = new List<Talent>();
        }
        catch (Exception ex)
        {
            apiError = $"Failed to load talent profiles: {ex.Message}";
            Console.WriteLine($"{apiError}");
            talents = new List<Talent>();
        }
    }

    private async Task LoadExperiences()
    {
        Console.WriteLine("Loading experiences...");
        try
        {
            if (!string.IsNullOrEmpty(LoggedInUserId))
            {
                experiences = await ExperienceService.GetMyExperiencesAsync(LoggedInUserId);
            }
            if (experiences == null) experiences = new List<Experience>();
        }
        catch (Exception ex)
        {
            apiError = (apiError ?? "") + $" Failed to load experiences: {ex.Message}";
            Console.WriteLine($"Failed to load experiences. Error: {ex.Message}");
            experiences = new List<Experience>();
            Console.WriteLine($"Exception details: {ex}");
        }
    }

    private void ShowAddModal()
    {
        editingExperience = new Experience();
        if (talents != null && talents.Any())
        {
            // If there's only one talent profile, or to pre-select the first available one.
            editingExperience.TalentId = talents.FirstOrDefault()?.Id ?? 0;
        } else {
            editingExperience.TalentId = 0; // No talents to select
        }
        showModal = true;
    }

    private void ShowEditModal(Experience exp)
    {
        // Create a new instance to avoid modifying the original object in the list directly
        editingExperience = new Experience
        {
            Id = exp.Id,
            Title = exp.Title,
            CompanyName = exp.CompanyName,
            StartYear = exp.StartYear,
            EndYear = exp.EndYear,
            TalentId = exp.TalentId
        };
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        editingExperience = new Experience(); // Clear the form
    }

    private async Task SaveExperience()
    {
        if (editingExperience.TalentId == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please select a Talent Profile.");
            return;
        }

        apiError = null;
        try
        {
            bool success = false;
            if (editingExperience.Id == 0) // New experience
            {
                var result = await ExperienceService.CreateExperienceAsync(editingExperience);
                success = result != null;
            }
            else // Existing experience
            {
                success = await ExperienceService.UpdateExperienceAsync(editingExperience);
            }

            if (success)
            {
                await LoadExperiences(); // Refresh the list
                CloseModal();
            }
            else
            {
                apiError = "Error saving experience.";
                Console.WriteLine(apiError);
                await JSRuntime.InvokeVoidAsync("alert", apiError);
            }
        }
        catch (Exception ex)
        {
            apiError = $"An exception occurred while saving the experience: {ex.Message}";
            Console.WriteLine(apiError);
            await JSRuntime.InvokeVoidAsync("alert", apiError);
        }
    }

    private async Task DeleteExperience(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this experience?"))
        {
            apiError = null;
            try
            {
                bool success = false;
                if (!string.IsNullOrEmpty(LoggedInUserId))
                {
                    success = await ExperienceService.DeleteExperienceAsync(id, LoggedInUserId);
                }
                
                if (success)
                {
                    await LoadExperiences(); // Refresh the list
                }
                else
                {
                    apiError = "Error deleting experience.";
                    Console.WriteLine(apiError);
                    await JSRuntime.InvokeVoidAsync("alert", apiError);
                }
            }
            catch (Exception ex)
            {
                apiError = $"An exception occurred while deleting the experience: {ex.Message}";
                Console.WriteLine(apiError);
                await JSRuntime.InvokeVoidAsync("alert", apiError);
            }
        }
    }
}
